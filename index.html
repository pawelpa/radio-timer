<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Radio Timer</title>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
            integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
    </head>
    <body>
        <style>
            .container {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            input[type="text"] {
                height: 30px;
                font-size: 1.2rem;
            }
            input[type="submit"] {
                height: 35px;
            }
            button {
                height: 35px;
            }
            .controls {
                margin-top: 10px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
        </style>
        <div class="container">
            <h3>Radio Timer</h3>
            <fieldset>
                <legend>Setup timeout</legend>

                <form id="timer">
                    <label for="inputHour">Hr:</label>
                    <input
                        type="text"
                        name="hour"
                        id="inputHour"
                        style="width: 35px"
                        value="0"
                        maxlength="2"
                    />
                    <label for="inputMinute">Min:</label>
                    <input
                        type="text"
                        name="minute"
                        id="inputMinute"
                        style="width: 35px"
                        value="0"
                        maxlength="2"
                        required
                    />

                    <input type="submit" value="Start" />
                    <button id="reset">Reset</button>
                </form>
            </fieldset>
            <br />
            <br />
            <fieldset>
                <legend>Choice source</legend>
                <select id="station">
                    <option
                        value="https://rs202-krk-cyfronet.rmfstream.pl/RMF5"
                    >
                        Spokojne przeboje
                    </option>
                    <option
                        selected
                        value="https://rs202-krk-cyfronet.rmfstream.pl/RMFCLASSIC48"
                    >
                        Classic & Films
                    </option>
                </select>
            </fieldset>
            <br />
            <br />
            <audio id="radio"></audio>
            <fieldset>
                <legend>Controls</legend>
                <div class="controls">
                    <button id="btncontrol" class="fas fa-play"></button>
                    <input
                        type="range"
                        name="rangecontrol"
                        id="inrange"
                        min="0"
                        max="100"
                        step="10"
                        value="50"
                    />
                </div>
            </fieldset>
            <!-- timer status -->
            <div>
                <p>
                    Remaining time: <span id="hour">00</span>:<span id="minute"
                        >00</span
                    >:<span id="secound">00</span>
                </p>
            </div>
        </div>
        <!-- script -->
        <script>
            let interval;
            let timerStopped = false;
            const url = "https://rs202-krk-cyfronet.rmfstream.pl/RMFCLASSIC48";
            const radio = document.getElementById("radio");
            const station = document.getElementById("station");
            const reset = document.getElementById("reset");
            let hour = document.getElementById("hour");
            let minute = document.getElementById("minute");
            let secound = document.getElementById("secound");
            let btncontrol = document.getElementById("btncontrol");
            radio.src = url;

            //set innerText on dom element
            function setText(element, value) {
                if (
                    +value <= 9 &&
                    +value > 0 &&
                    !value.toString().startsWith("0")
                ) {
                    element.innerText = "0" + value;
                } else if (+value == 0) {
                    element.innerText = "00";
                } else {
                    element.innerText = value;
                }
            }
            //get dom elemet innerText as integer value
            function getElInt(element) {
                return parseInt(element.innerText);
            }
            station.addEventListener("change", (e) => {
                //set radio element src attribute to selected url
                radio.src =
                    e.target.options[e.target.options.selectedIndex].value;
                radio.play();
            });
            reset.addEventListener("click", (e) => {
                e.preventDefault();
                clearInterval(interval);
                console.log("reset");
                setText(hour, 0);
                setText(minute, 0);
                setText(secound, 0);
            });
            btncontrol.addEventListener("click", (e) => {
                if (e.target.classList.contains("fa-play")) {
                    radio.play();
                    e.target.classList.toggle("fa-play");
                    e.target.classList.toggle("fa-pause");
                } else if (e.target.classList.contains("fa-pause")) {
                    e.target.classList.toggle("fa-pause");
                    e.target.classList.toggle("fa-play");
                    radio.pause();
                }
            });
            inrange.addEventListener("change", (e) => {
                radio.volume = e.target.value / 100;
            });

            function sleep(ms) {
                return new Promise((resolve) => setTimeout(resolve, ms));
            }

            async function timerUpdate() {
                if (getElInt(secound) > 0)
                    setText(secound, getElInt(secound) - 1);

                if (getElInt(secound) == 0) await sleep(1000);

                if (getElInt(secound) === 0 && getElInt(minute) > 0) {
                    setText(secound, 59);
                    setText(minute, getElInt(minute) - 1);
                } else if (
                    getElInt(secound) === 0 &&
                    getElInt(minute) === 0 &&
                    getElInt(hour) > 0
                ) {
                    setText(hour, getElInt(hour) - 1);
                    setText(minute, 59);
                    setText(secound, 59);
                } else if (
                    /* timer stopped */
                    !timerStopped &&
                    getElInt(hour) === 0 &&
                    getElInt(minute) === 0 &&
                    getElInt(secound) === 0
                ) {
                    timerStopped = true;
                    clearInterval(interval);
                    radio.pause();
                    btncontrol.classList.toggle("fa-pause");
                    btncontrol.classList.toggle("fa-play");
                    console.log("audio paused");
                }
            }

            timer.addEventListener("submit", (e) => {
                e.preventDefault();
                timerStopped = false;
                clearInterval(interval);

                //setup timer to given time
                setText(hour, e.target.inputHour.value || 0);
                setText(minute, e.target.inputMinute.value || 0);
                setText(secound, 0);

                if (!getElInt(hour) && !getElInt(minute) && !getElInt(secound))
                    return;

                //run timerUpdate function every 1 secound
                interval = setInterval(timerUpdate, 1000);
            });
        </script>
    </body>
</html>
